name: Terraform Module CI

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, closed]
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:

  # JOB 1: Terraform checks
  terraform-checks:
    if: github.event.pull_request.merged != true
    runs-on: ubuntu-latest

    steps:

      # Step 1: Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # Step 3: Initialize Terraform
      - name: Terraform Init
        run: terraform init -backend=false

      # Step 4: Check Terraform formatting
      - name: Terraform Format Check
        run: terraform fmt -check

      # Step 5: Validate Terraform configuration
      - name: Terraform Validate
        run: terraform validate


  # JOB 2: Version bump (runs only after PR merge)
  bump-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:

      # Step 1: Checkout repo with full history and tags
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # Step 2: Read PR body and detect checkbox selection
      - name: Get change type from PR body
        id: change
        run: |
          BODY="${{ github.event.pull_request.body }}"

          if echo "$BODY" | grep -iq "\[x\].*major"; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$BODY" | grep -iq "\[x\].*minor"; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif echo "$BODY" | grep -iq "\[x\].*patch"; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            echo "type=none" >> $GITHUB_OUTPUT
          fi


      # Step 3: Get latest version tag
      - name: Get latest tag
        id: tag
        run: |
          git fetch --tags
          TAG=$(git tag --sort=-v:refname | head -n 1)
          echo "tag=$TAG" >> $GITHUB_OUTPUT


      # Step 4: Calculate new version
      - name: Calculate new version
        id: bump
        if: steps.change.outputs.type != 'none'
        run: |

          VERSION=${{ steps.tag.outputs.tag }}
          VERSION=${VERSION#v}

          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          case "${{ steps.change.outputs.type }}" in
            major)
              MAJOR=$((MAJOR+1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR+1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH+1))
              ;;
          esac

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT


      # Step 5: Create and push new git tag
      - name: Create tag
        if: steps.change.outputs.type != 'none'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git tag ${{ steps.bump.outputs.new_version }}
          git push origin ${{ steps.bump.outputs.new_version }}


